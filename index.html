<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiColtivo</title>
    <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet'>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" integrity="sha512-dfX5uYVXzyU8+KHqj8bjo7UkOdg18PaOtpa48djpNbZHwExddghZ+ZmzWT06R5v6NSk3ZUfsH6FNEDepLx9hPQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
    <div class="logo">
        <img src="https://scontent-mxp1-1.xx.fbcdn.net/v/t39.30808-1/364099290_754732379786338_1182520479925901428_n.jpg?stp=dst-jpg_s200x200_tt6&_nc_cat=102&ccb=1-7&_nc_sid=2d3e12&_nc_ohc=3ptHrXwF8TcQ7kNvgEwmeaB&_nc_zt=24&_nc_ht=scontent-mxp1-1.xx&_nc_gid=ANe6iltqJmL52cj9I2xKds6&oh=00_AYAaPcnPSlcxBRcjinUqGXlcNLKv0HkIZO9XYX4P6KN5RA&oe=677D7504" alt="Logo">
    </div>
    <div class="search-bar">
        <input type="text" id="search" placeholder="Cerca prodotti...">
    </div>
    <div class="gallery" id="gallery"></div>

    <script>
        /**
         * Fetches and parses data from a CSV file in a remote API.
         * @returns {Promise<Array>} An array of items parsed from the CSV file.
         */
        async function fetchData() {
            try {
                const gistResponse = await fetch('https://api.github.com/gists/e9befc8c5f82912be9bbb7e51eb0e21d');
                const gistData = await gistResponse.json();
                const rawUrl = gistData.files["test_data.csv"].raw_url;

                const rawResponse = await fetch(rawUrl);
                const csvText = await rawResponse.text();

                // Use PapaParse to parse the CSV data
                const parsedData = Papa.parse(csvText, {
                    header: true, // Use the first row as header
                    skipEmptyLines: true // Ignore empty lines
                });

                return parsedData.data; // Returns the array of parsed data
            } catch (error) {
                console.error('Error fetching data:', error);
                return []; // Return an empty array in case of an error
            }
        }

        const gallery = document.getElementById('gallery');
        const searchInput = document.getElementById('search');

        /**
         * Displays items in the gallery.
         * @param {Array} items - Array of items to display.
         */
        function displayItems(items) {
            // Clear the gallery before displaying new items
            while (gallery.firstChild) {
                gallery.removeChild(gallery.firstChild);
            }

            // Iterate through each item and create DOM elements for it
            items.forEach(item => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'card';
                const img = document.createElement('img');
                img.src = item.immagine ? item.immagine : `https://placehold.co/200/${item.colore_sfondo || '8fa98c'}/white?text=${item.prodotto_short}&font=roboto`;
                img.alt = item.prodotto; // Accessibility: Alt text for the image

                cardDiv.appendChild(img);

                const containerDiv = document.createElement('div');
                containerDiv.className = 'container';

                const product = document.createElement('h4');
                product.textContent = item.prodotto;

                const productInfos = document.createElement('p');
                productInfos.textContent = `Codice: ${item.codice}\r\nPrezzo: ${item.prezzo} (${item.iva})`;

                containerDiv.appendChild(product);
                containerDiv.appendChild(productInfos);

                cardDiv.appendChild(containerDiv);
                gallery.appendChild(cardDiv); // Add item to the gallery
            });
        }

        /**
         * Filters items based on the search query and updates the gallery.
         */
        searchInput.addEventListener('input', (event) => {
            const query = event.target.value.toLowerCase(); // Convert query to lowercase
            const filteredItems = currentData.filter(item =>
                item.prodotto.toLowerCase().includes(query) ||
                item.codice.toLowerCase().includes(query) // Match name or code
            );
            displayItems(filteredItems); // Update the gallery with filtered items
        });

        let currentData = []; // Holds the current set of items

        /**
         * Initializes the gallery by fetching data and displaying it.
         */
        async function initializeGallery() {
            currentData = await fetchData();
            displayItems(currentData); // Display all items initially
        }

        // Initialize gallery on page load
        initializeGallery();
    </script>
</body>
</html>
